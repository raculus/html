<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Url QR</title>
    <style>
        :root {
            --bg: linear-gradient(135deg,#f6f8ff 0%,#e8f0ff 100%);
            --card: #fff;
            --muted: #6b7280;
        }
        html,body {
            height: 100%;
            margin: 0;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: var(--bg);
            color: #111827;
        }
        .wrap {
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .card {
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(17,24,39,0.06);
            padding: 28px;
            width: min(92vw, 420px);
            text-align: center;
        }
        h1 { margin: 0 0 8px; font-size: 18px; font-weight: 600; }
        p.desc { margin: 0 0 18px; color: var(--muted); font-size: 13px; }
        .input-group {
            margin-bottom: 14px;
            display:flex;
            gap:8px;
            justify-content:center;
            align-items:center;
        }
        .input-group input {
            width: 62%;
            padding: 8px 10px;
            border: 1px solid #e6e9ef;
            border-radius: 8px;
            font-size: 13px;
            outline: none;
        }
        .input-group button {
            padding: 8px 12px;
        }
        #qrcode { margin: 0 auto 12px; width: 280px; height: 280px; display: grid; place-items: center; }
        .value {
            font-size: 13px;
            color: var(--muted);
            word-break: break-all;
            padding: 6px 8px;
            background: #f8fafc;
            border-radius: 8px;
            display: inline-block;
        }
        .tools { margin-top: 16px; display:flex; justify-content:center; gap:8px; }
        button {
            padding: 8px 12px;
            border: none;
            background: #2563eb;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        button.secondary {
            background: transparent;
            color: #374151;
            border: 1px solid #e6e9ef;
        }
        @media (max-width:420px){
            #qrcode { width: 220px; height:220px; }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="card" role="main">
            <p class="desc">URL의 #이후를 QR로 생성합니다. (예: example.com/#abc → "abc")</p>

            <div class="input-group" aria-hidden="false">
                <input id="pathInput" type="text" placeholder="예: abc" aria-label="경로 입력" />
                <button id="applyBtn" title="입력한 값으로 QR 생성">생성</button>
            </div>

            <div id="qrcode" aria-hidden="true"></div>

            <div id="value" class="value" aria-live="polite"></div>

            <div class="tools">
                <button id="downloadBtn">QR 다운로드</button>
                <button class="secondary" id="copyBtn">경로 복사</button>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="../gukbob/qrcode.min.js"></script>
    <script>
        (function () {
            function getRawPathFromLocation() {
                if (window.location.hash && window.location.hash.length > 1) {
                    // decodeURIComponent 해서 인코딩 문자 처리
                    return decodeURIComponent(window.location.hash.slice(1));
                }
            }

            // 렌더링 함수
            const qrcodeEl = document.getElementById('qrcode');

            function renderFromLocation() {
                const rawPath = getRawPathFromLocation();
                if (!rawPath) return;
                const value = rawPath || window.location.href;
                const displayValue = rawPath || window.location.href;
                document.getElementById('value').textContent = displayValue;
                // input에 표시
                const inputEl = document.getElementById('pathInput');
                if (inputEl) inputEl.value = rawPath || '';

                // QR 생성 (기존 내용 정리)
                qrcodeEl.innerHTML = '';
                const qrNode = QRCode(value);
                qrcodeEl.appendChild(qrNode);
            }

            // 초기 렌더
            renderFromLocation();

            // hashchange 등으로 URL이 바뀌면 다시 렌더
            window.addEventListener('hashchange', renderFromLocation);
            window.addEventListener('popstate', renderFromLocation);
            window.addEventListener('pushstate', renderFromLocation);

            // 입력 및 적용 버튼 로직: input에 값을 넣고 생성하면 #해시를 바꿔서 render를 유도함
            const pathInput = document.getElementById('pathInput');
            const applyBtn = document.getElementById('applyBtn');
            applyBtn.addEventListener('click', () => {
                const v = (pathInput.value || '').trim();
                location.hash = v ? encodeURIComponent(v) : '';
            });
            pathInput.addEventListener('keydown', (ev) => {
                if (ev.key === 'Enter') {
                    applyBtn.click();
                }
            });

             // 다운로드 버튼: 이미지가 있으면 사용, 아니면 canvas 변환
             const downloadBtn = document.getElementById('downloadBtn');
             downloadBtn.addEventListener('click', () => {
                 // qrcode.js는 브라우저에 따라 img 또는 table로 렌더링합니다.
                 // img가 있으면 그 src를 사용, 없으면 canvas로 변환
                 const img = qrcodeEl.querySelector('img');
                 if (img && img.src) {
                    const rawPath = getRawPathFromLocation();
                     downloadDataUrl(img.src, (rawPath || 'qrcode') + '.png');
                     return;
                 }
 
                 // table -> canvas 변환 (fallback)
                 const table = qrcodeEl.querySelector('table');
                 if (table) {
                     // 그리드를 읽어 canvas로 변환
                     const moduleSize = 6; // 픽셀 단위 확대 (크기 조절)
                     const rows = table.rows.length;
                     const cols = table.rows[0].cells.length;
                     const canvas = document.createElement('canvas');
                     canvas.width = cols * moduleSize;
                     canvas.height = rows * moduleSize;
                     const ctx = canvas.getContext('2d');
 
                     for (let r = 0; r < rows; r++) {
                         for (let c = 0; c < cols; c++) {
                             const isDark = table.rows[r].cells[c].style.backgroundColor !== '' && table.rows[r].cells[c].style.backgroundColor !== 'transparent';
                             ctx.fillStyle = isDark ? '#111827' : '#ffffff';
                             ctx.fillRect(c * moduleSize, r * moduleSize, moduleSize, moduleSize);
                         }
                     }
                     const url = canvas.toDataURL('image/png');
                     const rawPath = getRawPathFromLocation();
                     downloadDataUrl(url, (rawPath || 'qrcode') + '.png');
                     return;
                 }
 
                 alert('QR 이미지를 찾을 수 없습니다.');
             });
 
             // 복사 버튼: 경로 값 복사
             const copyBtn = document.getElementById('copyBtn');
             copyBtn.addEventListener('click', async () => {
                 try {
                    const rawPath = getRawPathFromLocation();
                    const value = rawPath || window.location.href;
                     await navigator.clipboard.writeText(value);
                     copyBtn.textContent = '복사됨';
                     setTimeout(() => copyBtn.textContent = '경로 복사', 1200);
                 } catch (e) {
                     alert('클립보드에 복사할 수 없습니다.');
                 }
             });
 
             function downloadDataUrl(dataUrl, filename) {
                 const a = document.createElement('a');
                 a.href = dataUrl;
                 a.download = filename;
                 document.body.appendChild(a);
                 a.click();
                 a.remove();
             }
         })();
     </script>
 </body>
 </html>