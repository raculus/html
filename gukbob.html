<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>미례국밥 전포점 - 일일 매출 입력</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], input[type="number"], input[type="date"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .row {
            display: flex;
            gap: 15px;
        }
        .col {
            flex: 1;
        }
        .calculated {
            background-color: #f0f8ff;
            border: 2px solid #87ceeb;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .section h3 {
            margin-top: 0;
            color: #444;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        .reset-btn {
            background-color: #f44336;
        }
        .reset-btn:hover {
            background-color: #da190b;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e8;
            border-radius: 5px;
            display: none;
        }
        .copy-btn {
            background-color: #007bff;
            margin-top: 10px;
        }
        .copy-btn:hover {
            background-color: #0056b3;
        }
        .collapsible {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .collapsible::after {
            content: '▼';
            font-size: 14px;
            transition: transform 0.3s ease;
        }
        .collapsible.collapsed::after {
            transform: rotate(-90deg);
        }
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .collapsible-content.collapsed {
            max-height: 0;
        }
        .popup {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transform: translateX(-50%) translateY(-100%);
            transition: all 0.3s ease;
        }
        
        .popup.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .popup.success {
            background-color: #28a745;
            border-left: 4px solid #1e7e34;
        }
        .popup.info {
            background-color: #17a2b8;
            border-left: 4px solid #117a8b;
        }
        
        .popup.error {
            background-color: #dc3545;
            border-left: 4px solid #bd2130;
        }
        
        /* 도움말 버튼 및 툴팁 스타일 */
        .help-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 8px;
        }
        
        .help-tooltip::before {
            content: '?';
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: #007bff;
            color: white;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            vertical-align: middle;
        }
        
        .help-tooltip:hover::before {
            background-color: #0056b3;
        }
        
        .help-tooltip::after {
            content: attr(data-help);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            min-width: max-content;
            max-width: 250px;
            text-align: center;
            line-height: 1.4;
            pointer-events: none;
            word-break: keep-all;
        }
        
        /* 긴 텍스트는 적절한 너비에서 줄바꿈 */
        .help-tooltip[data-help*="입력하세요"]::after,
        .help-tooltip[data-help*="계산됩니다"]::after,
        .help-tooltip[data-help*="관리"]::after {
            white-space: normal;
            min-width: 150px;
        }
        
        .help-tooltip:hover::after,
        .help-tooltip:focus::after {
            opacity: 1;
            visibility: visible;
        }
        
        /* 툴팁 화살표 */
        .help-tooltip:hover::after {
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* 모바일에서는 터치 시 툴팁 표시 */
        @media (hover: none) {
            .help-tooltip:active::after {
                opacity: 1;
                visibility: visible;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>미례국밥 전포점 - 일일 매출 입력</h1>
        
        <form id="salesForm">
            <div class="section">
                <h3 class="collapsible" onclick="toggleCollapse('reportSection')">보고서 불러오기</h3>
                <div id="reportSection" class="collapsible-content">
                    <div class="form-group">
                        <label for="reportInput">생성된 보고서 텍스트</label>
                        <textarea id="reportInput" name="reportInput" placeholder="생성된 보고서를 여기에 붙여넣으세요..." rows="5"></textarea>
                    </div>
                    <div style="text-align: center;">
                        <button type="button" onclick="loadFromReport()">보고서에서 데이터 불러오기</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>데이터 저장/불러오기</h3>
                <div style="text-align: center;">
                    <button type="button" onclick="saveDataManually()">URL에 데이터 저장 & 복사</button>
                    <button type="button" onclick="clearSavedData()">저장된 데이터 삭제</button>
                </div>
                <!-- <div style="margin-top: 15px; padding: 10px; background-color: #e3f2fd; border-radius: 5px; font-size: 14px; color: #1565c0;">
                    <strong>압축 저장</strong> 데이터가 자동으로 압축되어 URL에 저장됩니다. 긴 데이터도 짧은 URL로 변환하여 공유가 쉽습니다!
                </div> -->
            </div>

            <div class="form-group">
                <label for="date">날짜 선택</label>
                <input type="date" id="date" name="date" required>
            </div>

            <div class="section">
                <h3>매출<span class="help-tooltip" data-help="하루 동안의 매출 관련 정보를 입력하는 섹션입니다."></span></h3>
                <div class="row">
                    <div class="col">
                        <label for="cash">현금</label>
                        <input type="number" id="cash" name="cash" placeholder="13,000" oninput="calculateTotal()">
                    </div>
                    <div class="col">
                        <label for="card">카드</label>
                        <input type="number" id="card" name="card" placeholder="1,512,500" oninput="calculateTotal()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="totalSales">현금+카드 총매출</label>
                    <input type="number" id="totalSales" name="totalSales" class="calculated" readonly>
                </div>

                <div class="row">
                    <div class="col">
                        <label for="service">서비스<span class="help-tooltip" data-help="무료로 제공한 서비스의 금액을 입력하세요."></span></label>
                        <input type="number" id="service" name="service" placeholder="0" value="0">
                    </div>
                    <div class="col">
                        <label for="refund">반품액<span class="help-tooltip" data-help="반품 처리한 금액을 입력하세요."></span></label>
                        <input type="number" id="refund" name="refund" placeholder="0" value="0" oninput="calculateSalesTotal()">
                    </div>
                </div>

                <div class="form-group">
                    <label for="salesTotal">매출합계<span class="help-tooltip" data-help="총매출에서 반품액을 뺀 최종 매출입니다."></span></label>
                    <input type="number" id="salesTotal" name="salesTotal" class="calculated" readonly>
                </div>

                <div class="form-group">
                    <label for="refundDetail">반품상세내역<span class="help-tooltip" data-help="반품 사유나 상세 내역을 입력하세요."></span></label>
                    <textarea id="refundDetail" name="refundDetail" placeholder="반품 상세 내역 입력" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label for="monthlyTotal">월누적매출<span class="help-tooltip" data-help="이번 달 누적 매출액을 입력하세요."></span></label>
                    <input type="number" id="monthlyTotal" name="monthlyTotal" placeholder="31,748,000" oninput="calculatePredictedMonthly()">
                    <div id="monthlyPrediction" style="margin-top: 10px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; display: none;">
                        <div style="font-size: 14px; color: #856404; margin-bottom: 8px;">
                            <strong>예상 월누적매출</strong> <span id="predictedMonthlyTotal">0</span>원
                        </div>
                        <div style="text-align: center;">
                            <button type="button" onclick="applyPredictedMonthly()" style="background-color: #28a745; font-size: 14px; padding: 8px 16px;">예상값 적용</button>
                            <button type="button" onclick="hidePrediction()" style="background-color: #6c757d; font-size: 14px; padding: 8px 16px;">무시</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>시재 정보<span class="help-tooltip" data-help="보통 수정하지 않습니다"></span></h3>
                <div class="row">
                    <div class="col">
                        <label for="todayCash">금일시제</label>
                        <input type="number" id="todayCash" name="todayCash" placeholder="100,000" value="100000">
                    </div>
                    <div class="col">
                        <label for="tomorrowCash">익일시제</label>
                        <input type="number" id="tomorrowCash" name="tomorrowCash" placeholder="100,000" value="100000">
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>지출 정보<span class="help-tooltip" data-help="종량제 구매등 지출시 발생하는 내역입니다."></span></h3>
                <div class="row">
                    <div class="col">
                        <label for="expenseCard">카드 지출</label>
                        <input type="number" id="expenseCard" name="expenseCard" placeholder="0" value="0" oninput="calculateExpenseTotal()">
                    </div>
                    <div class="col">
                        <label for="expenseCash">현금 지출</label>
                        <input type="number" id="expenseCash" name="expenseCash" placeholder="0" value="0" oninput="calculateExpenseTotal()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="expenseTotal">지출 총액</label>
                    <input type="number" id="expenseTotal" name="expenseTotal" class="calculated" readonly>
                </div>

                <div class="row">
                    <div class="col">
                        <label for="shortageAmount">과부족 금액<span class="help-tooltip" data-help="마감정산 화면에서의 과부족 금액입니다. 현재시재 입력 후 사용합니다."></span></label>
                        <input type="number" id="shortageAmount" name="shortageAmount" placeholder="-12345">
                    </div>
                    <div class="col">
                        <label for="transferCount">계좌이체 건수</label>
                        <input type="number" id="transferCount" name="transferCount" placeholder="">
                    </div>
                </div>

                <div class="form-group">
                    <label for="shortage">과부족</label>
                    <input type="text" id="shortage" name="shortage" class="calculated" readonly>
                </div>
            </div>

            <div class="section">
                <h3>기타 정보</h3>
                <div class="row">
                    <div class="col">
                        <label for="review">리뷰<span class="help-tooltip" data-help="네이버 플레이스에서의 리뷰수 입니다."></span></label>
                        <input type="number" id="review" name="review" placeholder="3">
                    </div>
                    <div class="col">
                        <label for="revisit">재방문<span class="help-tooltip" data-help="재방문 고객님을 직접 체크하여 작성합니다."></span></label>
                        <input type="number" id="revisit" name="revisit" placeholder="6">
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <label for="experienceAmount">체험단 서비스 금액<span class="help-tooltip" data-help="체험단 1팀당 최대 25,000원입니다. (예를들어 23,000원 체험단 시 23,000이고 31,000체험단 시 25,000입니다.)"></span></label>
                        <input type="number" id="experienceAmount" name="experienceAmount" placeholder="0" oninput="handleExperienceAmountChange()">
                    </div>
                    <div class="col">
                        <label for="experienceCount">체험단 서비스 건수</label>
                        <input type="number" id="experienceCount" name="experienceCount" placeholder="0" oninput="handleExperienceCountChange()">
                    </div>
                </div>

                <div class="form-group">
                    <label for="experienceService">체험단 서비스내역</label>
                    <input type="text" id="experienceService" name="experienceService" class="calculated" readonly>
                </div>

                <div class="row">
                    <div class="col">
                        <label for="deliveryAmount">배민포장 금액</label>
                        <input type="number" id="deliveryAmount" name="deliveryAmount" placeholder="0" oninput="handleDeliveryAmountChange()">
                    </div>
                    <div class="col">
                        <label for="deliveryCount">배민포장 횟수</label>
                        <input type="number" id="deliveryCount" name="deliveryCount" placeholder="0" oninput="handleDeliveryCountChange()">
                    </div>
                </div>

                <div class="form-group">
                    <label for="delivery">배민포장</label>
                    <input type="text" id="delivery" name="delivery" class="calculated" readonly>
                </div>
            </div>

            <div class="section">
                <h3>현금 계산<span class="help-tooltip" data-help="현금 관리와 계산을 위한 섹션입니다."></span></h3>
                <div class="form-group">
                    <label for="currentCash">현재시재<span class="help-tooltip" data-help="돈봉투를 제외한 포스기 현금입니다."></span></label>
                    <input type="number" id="currentCash" name="currentCash" placeholder="0" min="0" oninput="calculateCashNeeded()">
                </div>

                <div class="form-group">
                    <label for="targetCash">목표시재<span class="help-tooltip" data-help="목표로 하는 시재 금액입니다."></span></label>
                    <input type="number" id="targetCash" name="targetCash" placeholder="100,000" value="100000" min="0" oninput="calculateCashNeeded()">
                </div>

                <div class="form-group">
                    <label for="cashEnvelope">돈봉투 금액<span class="help-tooltip" data-help="돈봉투에 들어있는 현금입니다."></span></label>
                    <input type="number" id="cashEnvelope" name="cashEnvelope" placeholder="0" min="0" oninput="calculateCashNeeded()">
                </div>

                <div class="form-group">
                    <label for="cashTotal">현금총액<span class="help-tooltip" data-help="현재시재 + 돈봉투 금액의 합계입니다."></span></label>
                    <input type="number" id="cashTotal" name="cashTotal" class="calculated" readonly>
                </div>

                <div class="form-group">
                    <label for="cashDeposit">필요 현금입금액<span class="help-tooltip" data-help="목표시재를 맞추기 위해 필요한 금액입니다."></span></label>
                    <input type="number" id="cashDeposit" name="cashDeposit" class="calculated" readonly>
                </div>

                <div class="form-group">
                    <label for="cashAdjustment">돈봉투 증감량<span class="help-tooltip" data-help="돈봉투에서 사용하거나 추가할 금액입니다."></span></label>
                    <input type="number" id="cashAdjustment" name="cashAdjustment" class="calculated" readonly>
                </div>

                <div class="form-group">
                    <label for="finalCashEnvelope">최종 돈봉투 금액<span class="help-tooltip" data-help="계산 후 돈봉투에 남을 금액입니다."></span></label>
                    <input type="number" id="finalCashEnvelope" name="finalCashEnvelope" class="calculated" readonly>
                </div>

                <div class="form-group">
                    <label for="cashCalculation">현금 계산<span class="help-tooltip" data-help="현금 계산 과정을 보여줍니다."></span></label>
                    <input type="text" id="cashCalculation" name="cashCalculation" class="calculated" readonly>
                </div>
            </div>

            <div class="section">
                <h3>통장 관리<span class="help-tooltip" data-help="은행에서 통장입금 시 사용합니다."></span></h3>
                <div class="form-group">
                    <label for="bankAccount">통장 잔액</label>
                    <input type="number" id="bankAccount" name="bankAccount" placeholder="0" class="calculated">
                </div>
                
                <div class="row">
                    <div class="col">
                        <label for="bankAdjustment">증감 금액</label>
                        <input type="number" id="bankAdjustment" name="bankAdjustment" placeholder="0">
                    </div>
                    <div class="col">
                        <div style="display: flex; gap: 10px; margin-top: 30px;">
                            <button type="button" onclick="adjustBankAccount('+')">+ 입금</button>
                            <button type="button" onclick="adjustBankAccount('-')">- 출금</button>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center;">
                <button type="button" onclick="generateReport()">보고서 생성</button>
                <button type="reset" class="reset-btn" onclick="resetForm()">초기화</button>
            </div>
        </form>

        <div id="result" class="result">
            <h3>생성된 보고서</h3>
            <pre id="reportContent"></pre>
            <div style="text-align: center;">
                <button type="button" id="copyBtn" class="copy-btn" onclick="copyReport()">보고서 복사</button>
            </div>
        </div>
    </div>

    <script>
        // 팝업 표시 함수
        function showPopup(message, type = 'success') {
            // 기존 팝업이 있으면 제거
            const existingPopup = document.querySelector('.popup');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            // 새 팝업 생성
            const popup = document.createElement('div');
            popup.className = `popup ${type}`;
            popup.textContent = message;
            
            // body에 추가
            document.body.appendChild(popup);
            
            // 애니메이션 시작
            setTimeout(() => {
                popup.classList.add('show');
            }, 10);
            
            // 3초 후 자동 제거
            setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => {
                    if (popup.parentNode) {
                        popup.parentNode.removeChild(popup);
                    }
                }, 300);
            }, 3000);
        }

        // 오늘 날짜를 기본값으로 설정
        document.addEventListener('DOMContentLoaded', function() {
            // 이전 입력값 불러오기 (날짜 설정 전에)
            loadSavedData();
            
            // API에서 리뷰 개수 불러오기
            loadReviewCount();
            
            // 자동 저장 설정
            setupAutoSave();
            
            // 초기 계산들
            calculateShortage();
            calculateExperience();
            calculateDelivery();
            Calculator.calculateCashNeeded();
            Calculator.calculatePredictedMonthly();
        });
        
        // 보고서 섹션 초기 높이 설정
        window.addEventListener('load', function() {
            const reportSection = document.getElementById('reportSection');
            const urlParams = new URLSearchParams(window.location.search);
            
            // 압축된 데이터가 있거나 기존 URL 파라미터가 있으면 보고서 섹션을 접힌 상태로 시작
            const hasData = urlParams.get('d') || (urlParams.toString() && !urlParams.has('d'));
            
            if (hasData) {
                // 데이터가 있으면 접힌 상태로 설정
                collapseSection('reportSection');
            } else {
                // 데이터가 없으면 펼친 상태로 설정
                reportSection.style.maxHeight = reportSection.scrollHeight + 'px';
            }
        });

        // 필드명 매핑 (긴 필드명 → 짧은 코드)
        const fieldMapping = {
            // 매출 정보
            'monthlyTotal': 'mt',
            
            // 현금 계산 (현재시재는 제외)
            'targetCash': 'tg',
            'cashEnvelope': 'ce',
            
            // 통장
            'bankAccount': 'ba',
            'bankAdjustment': 'bad'
        };

        // 역매핑 (짧은 코드 → 긴 필드명)
        const reverseFieldMapping = Object.fromEntries(
            Object.entries(fieldMapping).map(([key, value]) => [value, key])
        );

        // 데이터 압축 함수
        function compressData(data) {
            // 저장에서 제외할 필드들
            const excludeFields = [
                'service', 'refund', 'refundDetail', 'review', 'revisit',
                'experienceAmount', 'experienceCount', 'deliveryAmount', 'deliveryCount',
                'date', 'shortageAmount', 'transferCount', 'cash', 'card', 
                'expenseCard', 'expenseCash', 'currentCash', 'todayCash', 'tomorrowCash'
            ];
            
            // 기본값이 있는 필드들 (이 필드들은 기본값과 다를 때만 저장)
            const defaultValues = {
                'targetCash': '100000'
            };
            
            // 1. 필드명을 짧은 코드로 변환
            const compressed = {};
            Object.keys(data).forEach(key => {
                // 제외할 필드가 아니고, 매핑에 있는 필드인 경우
                if (!excludeFields.includes(key) && fieldMapping[key] && data[key] && data[key] !== '') {
                    // 기본값이 있는 필드는 기본값과 다를 때만 저장
                    if (defaultValues[key]) {
                        if (data[key] !== defaultValues[key]) {
                            compressed[fieldMapping[key]] = data[key];
                        }
                    } else {
                        // 기본값이 없는 필드는 빈 값이 아닌 경우 저장 (0도 포함)
                        compressed[fieldMapping[key]] = data[key];
                    }
                }
            });
            
            // 2. JSON으로 변환 후 Base64 인코딩
            const jsonString = JSON.stringify(compressed);
            const base64String = btoa(unescape(encodeURIComponent(jsonString)));
            
            return base64String;
        }

        // 데이터 압축 해제 함수
        function decompressData(compressedData) {
            try {
                // 1. Base64 디코딩
                const jsonString = decodeURIComponent(escape(atob(compressedData)));
                const compressed = JSON.parse(jsonString);
                
                // 2. 필드명을 원래대로 복원
                const decompressed = {};
                Object.keys(compressed).forEach(key => {
                    if (reverseFieldMapping[key]) {
                        const originalKey = reverseFieldMapping[key];
                        decompressed[originalKey] = compressed[key];
                    }
                });
                
                return decompressed;
            } catch (error) {
                console.error('데이터 압축 해제 실패:', error);
                return {};
            }
        }

        // URL에 데이터 저장 함수 (압축 적용)
        function saveData() {
            const formData = new FormData(document.getElementById('salesForm'));
            const data = Object.fromEntries(formData);
            
            // 날짜는 저장에서 제외
            delete data.date;
            
            // 데이터 압축
            const compressedData = compressData(data);
            
            if (compressedData && compressedData.length > 0) {
                // URL 파라미터로 압축된 데이터 사용
                const newUrl = window.location.pathname + '?d=' + encodeURIComponent(compressedData);
                
                // URL 업데이트 (페이지 새로고침 없이)
                window.history.replaceState({}, '', newUrl);
                console.log('URL에 데이터 저장됨:', newUrl.substring(0, 100) + '...');
            }
        }

        // URL에서 데이터 불러오기 함수 (압축 해제 적용)
        function loadSavedData() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // 압축된 데이터가 있는지 확인
            const compressedData = urlParams.get('d');
            
            if (compressedData) {
                try {
                    // 압축 해제
                    const data = decompressData(compressedData);
                    
                    // 데이터 로드
                    Object.keys(data).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && key !== 'date') {
                            element.value = data[key];
                        }
                    });
                    
                    // 계산 함수들 실행
                    Calculator.calculateTotal();
                    Calculator.calculateExpenseTotal();
                    calculateShortage();
                    calculateExperience();
                    calculateDelivery();
                    Calculator.calculateCashNeeded();
                    Calculator.calculatePredictedMonthly();
                } catch (error) {
                    console.error('압축 해제 중 오류:', error);
                }
            } else {
                // 기존 비압축 URL 파라미터 지원 (하위 호환성)
                const hasOldParams = urlParams.toString() && !urlParams.has('d');
                if (hasOldParams) {
                    urlParams.forEach((value, key) => {
                        const element = document.getElementById(key);
                        if (element && key !== 'date') {
                            element.value = value;
                        }
                    });
                    
                    // 계산 함수들 실행
                    Calculator.calculateTotal();
                    Calculator.calculateExpenseTotal();
                    calculateShortage();
                    calculateExperience();
                    calculateDelivery();
                    Calculator.calculateCashNeeded();
                    Calculator.calculatePredictedMonthly();
                    
                    // 기존 URL을 압축된 형태로 변환
                    saveData();
                } else {
                    // localStorage에서 마이그레이션 (기존 데이터)
                    const savedData = localStorage.getItem('salesFormData');
                    if (savedData) {
                        try {
                            const data = JSON.parse(savedData);
                            
                            Object.keys(data).forEach(key => {
                                if (key !== 'date') {
                                    const element = document.getElementById(key);
                                    if (element && data[key] !== '') {
                                        element.value = data[key];
                                    }
                                }
                            });
                            
                            // 계산 함수들 실행
                            Calculator.calculateTotal();
                            Calculator.calculateExpenseTotal();
                            calculateShortage();
                            calculateExperience();
                            calculateDelivery();
                            Calculator.calculateCashNeeded();
                            Calculator.calculatePredictedMonthly();
                            
                            // localStorage 데이터를 압축된 URL로 이전 후 삭제
                            saveData();
                            localStorage.removeItem('salesFormData');
                        } catch (error) {
                            console.error('저장된 데이터를 불러오는 중 오류가 발생했습니다:', error);
                        }
                    }
                }
            }
            
            // 날짜 필드가 비어있을 때만 오늘 날짜로 설정
            const dateInput = document.getElementById('date');
            if (!dateInput.value) {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
            }
        }

        // 입력값이 변경될 때마다 자동 저장
        function setupAutoSave() {
            const form = document.getElementById('salesForm');
            const inputs = form.querySelectorAll('input, textarea');
            
            // 저장에서 제외할 필드들
            const excludeFields = [
                'service', 'refund', 'refundDetail', 'review', 'revisit',
                'experienceAmount', 'experienceCount', 'deliveryAmount', 'deliveryCount',
                'date', 'shortageAmount', 'transferCount', 'cash', 'card', 
                'expenseCard', 'expenseCash', 'currentCash', 'reportInput', 'todayCash', 'tomorrowCash'
            ];
            
            inputs.forEach(input => {
                // 제외할 필드가 아니고 계산된 필드도 아닌 경우에만 자동 저장 이벤트 등록
                if (!excludeFields.includes(input.name) && 
                    !input.name.includes('date') && 
                    !input.classList.contains('calculated')) {
                    
                    // 기존 이벤트 리스너 제거 후 새로 추가
                    input.removeEventListener('input', saveData);
                    input.removeEventListener('change', saveData);
                    
                    input.addEventListener('input', function() {
                        // 약간의 지연을 두어 연속 입력 시 성능 향상
                        clearTimeout(this.saveTimeout);
                        this.saveTimeout = setTimeout(saveData, 300);
                    });
                    
                    input.addEventListener('change', saveData);
                }
            });
            
            console.log('자동 저장 설정 완료');
        }

        // 접기/펼치기 함수
        function toggleCollapse(elementId) {
            const content = document.getElementById(elementId);
            const header = content.previousElementSibling;
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                header.classList.remove('collapsed');
                content.style.maxHeight = content.scrollHeight + 'px';
            } else {
                content.classList.add('collapsed');
                header.classList.add('collapsed');
                content.style.maxHeight = '0px';
            }
        }

        // 섹션 접기 함수
        function collapseSection(elementId) {
            const content = document.getElementById(elementId);
            const header = content.previousElementSibling;
            
            content.classList.add('collapsed');
            header.classList.add('collapsed');
            content.style.maxHeight = '0px';
        }

        function calculateTotal() {
            const cash = parseFloat(document.getElementById('cash').value) || 0;
            const card = parseFloat(document.getElementById('card').value) || 0;
            const total = cash + card;
            document.getElementById('totalSales').value = total;
            calculateSalesTotal();
        }

        function calculateSalesTotal() {
            const totalSales = parseFloat(document.getElementById('totalSales').value) || 0;
            const refund = parseFloat(document.getElementById('refund').value) || 0;
            const salesTotal = totalSales - refund;
            document.getElementById('salesTotal').value = salesTotal;
            
            // 월누적매출 예상값 계산
            calculatePredictedMonthly();
        }

        function calculateExpenseTotal() {
            const expenseCard = parseFloat(document.getElementById('expenseCard').value) || 0;
            const expenseCash = parseFloat(document.getElementById('expenseCash').value) || 0;
            const expenseTotal = expenseCard + expenseCash;
            document.getElementById('expenseTotal').value = expenseTotal;
        }

        // 공통 필드 처리 함수들
        function createAmountCountHandler(config) {
            return {
                calculateDisplay: function() {
                    const amount = parseFloat(document.getElementById(config.amountId).value) || 0;
                    const count = parseInt(document.getElementById(config.countId).value) || 0;
                    
                    let displayText;
                    if (config.type === 'shortage') {
                        displayText = amount !== 0 ? `${amount.toLocaleString()}원` : '0원';
                        if (amount !== 0 && count > 0) {
                            displayText += `(계좌이체 ${count}건)`;
                        }
                    } else if (config.type === 'experience') {
                        displayText = `${amount.toLocaleString()}원(${count}건)`;
                    } else if (config.type === 'delivery') {
                        displayText = `${count}회(${amount.toLocaleString()}원)`;
                    }
                    
                    document.getElementById(config.displayId).value = displayText;
                },
                
                handleAmountChange: function() {
                    const amount = parseFloat(document.getElementById(config.amountId).value) || 0;
                    const count = parseInt(document.getElementById(config.countId).value) || 0;
                    
                    if (config.type === 'shortage') {
                        if (amount !== 0 && count === 0) {
                            document.getElementById(config.countId).value = 1;
                        } else if (amount === 0 && count !== 0) {
                            document.getElementById(config.countId).value = 0;
                        }
                    } else {
                        // experience, delivery 공통 로직
                        if (amount > 0 && count === 0) {
                            document.getElementById(config.countId).value = 1;
                        } else if (amount === 0 && count !== 0) {
                            document.getElementById(config.countId).value = 0;
                        }
                    }
                    
                    this.calculateDisplay();
                },
                
                handleCountChange: function() {
                    const amount = parseFloat(document.getElementById(config.amountId).value) || 0;
                    const count = parseInt(document.getElementById(config.countId).value) || 0;
                    
                    if (count === 0 && amount !== 0) {
                        document.getElementById(config.amountId).value = 0;
                    } else if (config.type === 'shortage' && count > 0 && amount === 0) {
                        document.getElementById(config.amountId).value = -13000;
                    }
                    
                    this.calculateDisplay();
                }
            };
        }

        // 각 필드별 핸들러 생성
        const shortageHandler = createAmountCountHandler({
            type: 'shortage',
            amountId: 'shortageAmount',
            countId: 'transferCount',
            displayId: 'shortage'
        });

        const experienceHandler = createAmountCountHandler({
            type: 'experience',
            amountId: 'experienceAmount',
            countId: 'experienceCount',
            displayId: 'experienceService'
        });

        const deliveryHandler = createAmountCountHandler({
            type: 'delivery',
            amountId: 'deliveryAmount',
            countId: 'deliveryCount',
            displayId: 'delivery'
        });

        // 기존 함수들을 핸들러로 대체
        function calculateShortage() { shortageHandler.calculateDisplay(); }
        function handleShortageAmountChange() { shortageHandler.handleAmountChange(); }
        function handleTransferCountChange() { shortageHandler.handleCountChange(); }

        function calculateExperience() { experienceHandler.calculateDisplay(); }
        function handleExperienceAmountChange() { experienceHandler.handleAmountChange(); }
        function handleExperienceCountChange() { experienceHandler.handleCountChange(); }

        function calculateDelivery() { deliveryHandler.calculateDisplay(); }
        function handleDeliveryAmountChange() { deliveryHandler.handleAmountChange(); }
        function handleDeliveryCountChange() { deliveryHandler.handleCountChange(); }

        // 공통 유틸리티 함수들
        const FormUtils = {
            // 숫자 값 파싱 (기본값 0)
            parseNumber: (value) => parseFloat(value) || 0,
            parseInteger: (value) => parseInt(value) || 0,
            
            // 요소 값 가져오기/설정하기
            getValue: (id) => document.getElementById(id).value,
            setValue: (id, value) => document.getElementById(id).value = value,
            getNumberValue: (id) => FormUtils.parseNumber(document.getElementById(id).value),
            getIntegerValue: (id) => FormUtils.parseInteger(document.getElementById(id).value),
            
            // 날짜 관련
            getTodayString: () => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },
            
            // 요일 계산
            getDayOfWeek: (dateStr) => {
                const days = ['일', '월', '화', '수', '목', '금', '토'];
                const date = new Date(dateStr);
                return days[date.getDay()];
            },
            
            // 숫자 포맷팅
            formatNumber: (num) => (num || 0).toLocaleString(),
            
            // 알림 표시
            showClipboardResult: (button, success = true) => {
                const originalText = button.textContent;
                const originalColor = button.style.backgroundColor;
                
                if (success) {
                    button.textContent = '복사완료!';
                    button.style.backgroundColor = '#28a745';
                } else {
                    button.textContent = '복사실패';
                    button.style.backgroundColor = '#dc3545';
                }
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.backgroundColor = originalColor;
                }, 2000);
            }
        };

        // 계산 함수들 통합
        const Calculator = {
            // 매출 관련 계산
            calculateTotal: () => {
                const cash = FormUtils.getNumberValue('cash');
                const card = FormUtils.getNumberValue('card');
                const total = cash + card;
                FormUtils.setValue('totalSales', total);
                Calculator.calculateSalesTotal();
            },

            calculateSalesTotal: () => {
                const totalSales = FormUtils.getNumberValue('totalSales');
                const refund = FormUtils.getNumberValue('refund');
                const salesTotal = totalSales - refund;
                FormUtils.setValue('salesTotal', salesTotal);
                Calculator.calculatePredictedMonthly();
            },

            calculateExpenseTotal: () => {
                const expenseCard = FormUtils.getNumberValue('expenseCard');
                const expenseCash = FormUtils.getNumberValue('expenseCash');
                const expenseTotal = expenseCard + expenseCash;
                FormUtils.setValue('expenseTotal', expenseTotal);
            },

            // 예상 월누적매출 계산
            calculatePredictedMonthly: () => {
                const currentMonthly = FormUtils.getNumberValue('monthlyTotal');
                const todaySales = FormUtils.getNumberValue('salesTotal');
                
                if (todaySales > 0 && currentMonthly >= 0) {
                    const predictedMonthly = currentMonthly + todaySales;
                    document.getElementById('predictedMonthlyTotal').textContent = FormUtils.formatNumber(predictedMonthly);
                    document.getElementById('monthlyPrediction').style.display = 'block';
                } else {
                    document.getElementById('monthlyPrediction').style.display = 'none';
                }
            },

            // 현금 계산
            calculateCashNeeded: () => {
                let currentCash = FormUtils.getNumberValue('currentCash');
                const targetCash = FormUtils.getNumberValue('targetCash') || 100000;
                let cashEnvelope = FormUtils.getNumberValue('cashEnvelope');
                
                // 현재시재가 음수가 되지 않도록 제한
                if (currentCash < 0) {
                    currentCash = 0;
                    FormUtils.setValue('currentCash', 0);
                }
                
                // 돈봉투금액이 음수가 되지 않도록 제한
                if (cashEnvelope < 0) {
                    cashEnvelope = 0;
                    FormUtils.setValue('cashEnvelope', 0);
                }
                
                // 현금총액 = 현재시재 + 돈봉투금액
                const cashTotal = currentCash + cashEnvelope;
                FormUtils.setValue('cashTotal', cashTotal);
                
                const neededCash = targetCash - currentCash;
                const cashAdjustment = -neededCash;
                let finalCashEnvelope = cashEnvelope - neededCash;
                
                // 최종 돈봉투 금액이 음수가 되지 않도록 제한
                if (finalCashEnvelope < 0) {
                    finalCashEnvelope = 0;
                    const adjustedNeededCash = cashEnvelope; // 돈봉투에서 가져올 수 있는 최대 금액
                    const remainingNeeded = neededCash - adjustedNeededCash;
                    
                    FormUtils.setValue('cashDeposit', remainingNeeded > 0 ? remainingNeeded : 0);
                    FormUtils.setValue('cashAdjustment', -adjustedNeededCash);
                } else {
                    FormUtils.setValue('cashDeposit', neededCash);
                    FormUtils.setValue('cashAdjustment', cashAdjustment);
                }
                
                FormUtils.setValue('finalCashEnvelope', finalCashEnvelope);
                
                // 계산식 표시
                let calculationText;
                if (finalCashEnvelope === 0 && neededCash > cashEnvelope) {
                    const usedFromEnvelope = cashEnvelope;
                    const remainingNeeded = neededCash - usedFromEnvelope;
                    calculationText = `돈봉투 ${FormUtils.formatNumber(cashEnvelope)}원 전액 사용 + 추가 입금 ${FormUtils.formatNumber(remainingNeeded)}원 필요`;
                } else if (neededCash >= 0) {
                    calculationText = `돈봉투 ${FormUtils.formatNumber(cashEnvelope)}원 - ${FormUtils.formatNumber(neededCash)}원 = ${FormUtils.formatNumber(finalCashEnvelope)}원`;
                } else {
                    calculationText = `돈봉투 ${FormUtils.formatNumber(cashEnvelope)}원 + ${FormUtils.formatNumber(Math.abs(neededCash))}원 = ${FormUtils.formatNumber(finalCashEnvelope)}원`;
                }
                
                FormUtils.setValue('cashCalculation', calculationText);
            }
        };

        // 기존 함수들을 Calculator로 대체
        function calculateTotal() { Calculator.calculateTotal(); }
        function calculateExpenseTotal() { Calculator.calculateExpenseTotal(); }
        function calculateCashNeeded() { Calculator.calculateCashNeeded(); }
        function calculatePredictedMonthly() { Calculator.calculatePredictedMonthly(); }

        // UI 관리 객체
        const UIManager = {
            // 접기/펼치기 기능
            toggleCollapse: (elementId) => {
                const content = document.getElementById(elementId);
                const header = content.previousElementSibling;
                
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    header.classList.remove('collapsed');
                    content.style.maxHeight = content.scrollHeight + 'px';
                } else {
                    content.classList.add('collapsed');
                    header.classList.add('collapsed');
                    content.style.maxHeight = '0px';
                }
            },

            collapseSection: (elementId) => {
                const content = document.getElementById(elementId);
                const header = content.previousElementSibling;
                
                content.classList.add('collapsed');
                header.classList.add('collapsed');
                content.style.maxHeight = '0px';
            },

            // 예상 월누적매출 관련
            applyPredictedMonthly: () => {
                const predictedValue = document.getElementById('predictedMonthlyTotal').textContent.replace(/,/g, '');
                FormUtils.setValue('monthlyTotal', predictedValue);
                document.getElementById('monthlyPrediction').style.display = 'none';
                saveData();
            },

            hidePrediction: () => {
                document.getElementById('monthlyPrediction').style.display = 'none';
            },

            // 통장 관리
            adjustBankAccount: (operation) => {
                const currentBank = FormUtils.getNumberValue('bankAccount');
                const adjustment = FormUtils.getNumberValue('bankAdjustment');
                
                if (adjustment === 0) {
                    alert('증감 금액을 입력해주세요.');
                    return;
                }
                
                const newBalance = operation === '+' ? currentBank + adjustment : currentBank - adjustment;
                
                FormUtils.setValue('bankAccount', newBalance);
                FormUtils.setValue('bankAdjustment', 0);
            }
        };

        // 기존 함수들을 UIManager로 대체
        function toggleCollapse(elementId) { UIManager.toggleCollapse(elementId); }
        function collapseSection(elementId) { UIManager.collapseSection(elementId); }
        function applyPredictedMonthly() { UIManager.applyPredictedMonthly(); }
        function hidePrediction() { UIManager.hidePrediction(); }
        function adjustBankAccount(operation) { UIManager.adjustBankAccount(operation); }

        // 보고서 관리 객체
        const ReportManager = {
            // 보고서에서 데이터 파싱
            parseFromReport: (reportText) => {
                const parsers = [
                    { regex: /현금:\s*([\d,]+)원/, id: 'cash' },
                    { regex: /카드:\s*([\d,]+)원/, id: 'card' },
                    { regex: /서비스:\s*([\d,]+)원/, id: 'service' },
                    { regex: /반품액:\s*([\d,]+)원/, id: 'refund' },
                    { regex: /반품상세내역:\s*(.+)/, id: 'refundDetail', isText: true },
                    { regex: /월누적매출:\s*([\d,]+)원/, id: 'monthlyTotal' },
                    { regex: /금일시제:\s*([\d,]+)원/, id: 'todayCash' },
                    { regex: /익일시제:\s*([\d,]+)원/, id: 'tomorrowCash' },
                    { regex: /카드\s*:\s*([\d,]+)원/, id: 'expenseCard' },
                    { regex: /현금\s*:\s*([\d,]+)원/, id: 'expenseCash' },
                    { regex: /리뷰:\s*(\d+)팀/, id: 'review' },
                    { regex: /재방문:\s*(\d+)팀/, id: 'revisit' },
                    { regex: /현금총액:\s*([\d,]+)원/, id: 'cashTotal' },
                    { regex: /돈봉투:\s*([\d,]+)원/, id: 'cashEnvelope' },
                    { regex: /통장:\s*([\d,]+)원/, id: 'bankAccount' }
                ];

                // 기본 필드 파싱
                parsers.forEach(parser => {
                    const match = reportText.match(parser.regex);
                    if (match) {
                        const value = parser.isText ? match[1] : match[1].replace(/,/g, '');
                        FormUtils.setValue(parser.id, value);
                    }
                });

                // 과부족 파싱 (복합 필드)
                const shortageMatch = reportText.match(/과부족:\s*(-?[\d,]+)원(?:\(계좌이체\s*(\d+)건\))?/);
                if (shortageMatch) {
                    FormUtils.setValue('shortageAmount', shortageMatch[1].replace(/,/g, ''));
                    if (shortageMatch[2]) {
                        FormUtils.setValue('transferCount', shortageMatch[2]);
                    }
                }

                // 체험단 서비스 파싱
                const experienceMatch = reportText.match(/체험단 서비스내역:\s*([\d,]+)원\((\d+)건\)/);
                if (experienceMatch) {
                    FormUtils.setValue('experienceAmount', experienceMatch[1].replace(/,/g, ''));
                    FormUtils.setValue('experienceCount', experienceMatch[2]);
                }

                // 배민포장 파싱
                const deliveryMatch = reportText.match(/배민포장:\s*(\d+)회\(([\d,]+)원\)/);
                if (deliveryMatch) {
                    FormUtils.setValue('deliveryCount', deliveryMatch[1]);
                    FormUtils.setValue('deliveryAmount', deliveryMatch[2].replace(/,/g, ''));
                }
            },

            // 보고서 생성
            generateReport: () => {
                const formData = new FormData(document.getElementById('salesForm'));
                const data = Object.fromEntries(formData);
                
                const defaults = {
                    cash: 0, card: 0, service: 0, refund: 0, refundDetail: '0원',
                    monthlyTotal: 0, todayCash: 100000, tomorrowCash: 100000,
                    expenseCard: 0, expenseCash: 0, shortage: '0원',
                    review: 0, revisit: 0, experienceService: '0원(0건)',
                    delivery: '0회(0원)', cashDeposit: 0
                };

                // 날짜 포맷팅
                const dateStr = data.date || FormUtils.getTodayString();
                const [year, month, day] = dateStr.split('-');
                const formattedDate = `${year}년 ${month}월 ${day}일 (${FormUtils.getDayOfWeek(dateStr)})`;

                // 매출 계산
                const cash = FormUtils.parseNumber(data.cash);
                const card = FormUtils.parseNumber(data.card);
                const totalSales = cash + card;
                const refund = FormUtils.parseNumber(data.refund);
                const salesTotal = totalSales - refund;
                const expenseCard = FormUtils.parseNumber(data.expenseCard);
                const expenseCash = FormUtils.parseNumber(data.expenseCash);
                const expenseTotal = expenseCard + expenseCash;
                
                const report = `${formattedDate} 미례국밥 전포점
총매출: ${FormUtils.formatNumber(totalSales)}원
 현금:  ${FormUtils.formatNumber(cash)}원
 카드:  ${FormUtils.formatNumber(card)}원
서비스: ${FormUtils.formatNumber(FormUtils.parseNumber(data.service))}원
 반품액: ${FormUtils.formatNumber(refund)}원
 매출합계: ${FormUtils.formatNumber(salesTotal)}원
반품상세내역: ${data.refundDetail || defaults.refundDetail}
월누적매출: ${FormUtils.formatNumber(FormUtils.parseNumber(data.monthlyTotal))}원
금일시제: ${FormUtils.formatNumber(FormUtils.parseNumber(data.todayCash) || defaults.todayCash)}원
익일시제: ${FormUtils.formatNumber(FormUtils.parseNumber(data.tomorrowCash) || defaults.tomorrowCash)}원
지출상세내역
  카드 : ${FormUtils.formatNumber(expenseCard)}원
  현금 : ${FormUtils.formatNumber(expenseCash)}원
  total: ${FormUtils.formatNumber(expenseTotal)}원
과부족:  ${data.shortage || defaults.shortage}
리뷰: ${data.review || defaults.review}팀
체험단 서비스내역: ${data.experienceService || defaults.experienceService}
재방문: ${data.revisit || defaults.revisit}팀
배민포장: ${data.delivery || defaults.delivery}
현금총액: ${FormUtils.formatNumber(FormUtils.parseNumber(data.cashTotal))}원
돈봉투: ${FormUtils.formatNumber(FormUtils.parseNumber(data.finalCashEnvelope) || FormUtils.parseNumber(data.cashEnvelope))}원
통장: ${FormUtils.formatNumber(FormUtils.parseNumber(data.bankAccount))}원`;

                document.getElementById('reportContent').textContent = report;
                document.getElementById('result').style.display = 'block';
            }
        };

        // 기존 함수들 대체
        function loadFromReport() {
            const reportText = FormUtils.getValue('reportInput');
            if (!reportText.trim()) {
                alert('보고서 텍스트를 입력해주세요.');
                return;
            }
            
            try {
                ReportManager.parseFromReport(reportText);
                
                // 계산 함수들 호출
                Calculator.calculateTotal();
                Calculator.calculateExpenseTotal();
                calculateShortage();
                calculateExperience();
                calculateDelivery();
                Calculator.calculateCashNeeded();
                Calculator.calculatePredictedMonthly();
                
                saveData();
                UIManager.collapseSection('reportSection');
                FormUtils.setValue('reportInput', '');
                
            } catch (error) {
                alert('보고서 형식을 인식할 수 없습니다. 올바른 보고서를 입력해주세요.');
                console.error('Error parsing report:', error);
            }
        }

        function generateReport() { ReportManager.generateReport(); }

        function getDayOfWeek(dateStr) { return FormUtils.getDayOfWeek(dateStr); }

        function copyReport() {
            const reportContent = document.getElementById('reportContent').textContent;
            const button = document.getElementById('copyBtn');
            
            navigator.clipboard.writeText(reportContent)
                .then(() => FormUtils.showClipboardResult(button, true))
                .catch(() => {
                    FormUtils.showClipboardResult(button, false);
                    alert('복사에 실패했습니다. 수동으로 복사해주세요.');
                });
        }

        function resetForm() {
            document.getElementById('salesForm').reset();
            
            // 날짜를 오늘로 설정
            FormUtils.setValue('date', FormUtils.getTodayString());
            
            document.getElementById('result').style.display = 'none';
            
            // 기본값들 설정
            const defaultValues = {
                'service': '0', 'refund': '0', 'todayCash': '100000', 'tomorrowCash': '100000',
                'expenseCard': '0', 'expenseCash': '0', 'shortageAmount': '0', 'transferCount': '0',
                'experienceAmount': '0', 'experienceCount': '0', 'deliveryCount': '0', 'deliveryAmount': '0',
                'targetCash': '100000', 'cashEnvelope': '0',
                'bankAccount': '0', 'bankAdjustment': '0', 'reportInput': ''
            };
            
            Object.entries(defaultValues).forEach(([id, value]) => FormUtils.setValue(id, value));
            
            // API에서 리뷰 개수 다시 불러오기
            loadReviewCount();
            
            // 계산 함수들 호출
            calculateShortage();
            calculateExperience();
            calculateDelivery();
            Calculator.calculateCashNeeded();
            Calculator.calculatePredictedMonthly();
        }

        // 수동 저장 함수 (URL 복사)
        function saveDataManually() {
            const originalUrl = window.location.href;
            const originalLength = originalUrl.length;
            
            saveData();
            
            const compressedUrl = window.location.href;
            const compressedLength = compressedUrl.length;
            const compressionRatio = originalLength > 0 ? ((originalLength - compressedLength) / originalLength * 100).toFixed(1) : 0;
            
            const message = `데이터가 압축되어 URL에 저장되었습니다!\nURL 길이: ${compressedLength}자\n압축률: ${compressionRatio > 0 ? compressionRatio + '% 단축' : '최적화됨'}`;
            
            navigator.clipboard.writeText(window.location.href)
                .then(() => alert(message + '\n클립보드에 복사되었습니다!'))
                .catch(() => alert(message + '\n\n' + window.location.href));
        }

        // 저장된 데이터 삭제
        function clearSavedData() {
            if (confirm('URL에 저장된 모든 데이터를 삭제하시겠습니까?')) {
                window.history.replaceState({}, '', window.location.pathname);
                resetForm();
                alert('URL에 저장된 데이터가 삭제되었습니다!');
            }
        }

        // API에서 리뷰 개수 불러오기
        async function loadReviewCount() {
            showPopup('리뷰 개수 불러오는 중...', 'info');
            try {
                // 현재 월.일 계산
                const today = new Date();
                const month = today.getMonth() + 1;
                const day = today.getDate();
                const monthDay = `${month}.${day}`;
                
                const apiUrl = `https://api.jaehy.uk/1688300738/count/${monthDay}`;
                console.log('API 호출:', apiUrl);
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.text();
                // data = API 응답: {"success":true,"placeId":"1688300738","targetDate":"8.10","count":0,"url":"https://m.place.naver.com/restaurant/1688300738/review/visitor?reviewSort=recent","extractedAt":"2025-08-09T19:26:51.652Z"}
                const jsonData = JSON.parse(data);
                const reviewCount = jsonData.count;

                if (isNaN(reviewCount)) {
                    throw new Error('Invalid response data');
                }
                
                FormUtils.setValue('review', reviewCount);
                showPopup('리뷰 불러오기 성공', 'success');
                console.log('리뷰 개수 로드 성공:', reviewCount);
                
            } catch (error) {
                console.error('리뷰 개수 로드 실패:', error);
                FormUtils.setValue('review', ''); // 빈칸으로 설정
                showPopup('리뷰개수 불러오기 실패', 'error');
            }
        }
    </script>
</body>
</html>