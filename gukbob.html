<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>미례국밥 전포점 - 일일 매출 입력</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], input[type="number"], input[type="date"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .row {
            display: flex;
            gap: 15px;
        }
        .col {
            flex: 1;
        }
        .calculated {
            background-color: #f0f8ff;
            border: 2px solid #87ceeb;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .section h3 {
            margin-top: 0;
            color: #444;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        .reset-btn {
            background-color: #f44336;
        }
        .reset-btn:hover {
            background-color: #da190b;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e8;
            border-radius: 5px;
            display: none;
        }
        .copy-btn {
            background-color: #007bff;
            margin-top: 10px;
        }
        .copy-btn:hover {
            background-color: #0056b3;
        }
        .collapsible {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .collapsible::after {
            content: '▼';
            font-size: 14px;
            transition: transform 0.3s ease;
        }
        .collapsible.collapsed::after {
            transform: rotate(-90deg);
        }
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .collapsible-content.collapsed {
            max-height: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>미례국밥 전포점 - 일일 매출 입력</h1>
        
        <form id="salesForm">
            <div class="section">
                <h3 class="collapsible" onclick="toggleCollapse('reportSection')">보고서 불러오기</h3>
                <div id="reportSection" class="collapsible-content">
                    <div class="form-group">
                        <label for="reportInput">생성된 보고서 텍스트:</label>
                        <textarea id="reportInput" name="reportInput" placeholder="생성된 보고서를 여기에 붙여넣으세요..." rows="5"></textarea>
                    </div>
                    <div style="text-align: center;">
                        <button type="button" onclick="loadFromReport()">보고서에서 데이터 불러오기</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>데이터 저장/불러오기</h3>
                <div style="text-align: center;">
                    <button type="button" onclick="saveDataManually()">URL에 데이터 저장 & 복사</button>
                    <button type="button" onclick="clearSavedData()">저장된 데이터 삭제</button>
                </div>
                <!-- <div style="margin-top: 15px; padding: 10px; background-color: #e3f2fd; border-radius: 5px; font-size: 14px; color: #1565c0;">
                    <strong>압축 저장:</strong> 데이터가 자동으로 압축되어 URL에 저장됩니다. 긴 데이터도 짧은 URL로 변환하여 공유가 쉽습니다!
                </div> -->
            </div>

            <div class="form-group">
                <label for="date">날짜 선택:</label>
                <input type="date" id="date" name="date" required>
            </div>

            <div class="section">
                <h3>매출 정보</h3>
                <div class="row">
                    <div class="col">
                        <label for="cash">현금:</label>
                        <input type="number" id="cash" name="cash" placeholder="13,000" oninput="calculateTotal()">
                    </div>
                    <div class="col">
                        <label for="card">카드:</label>
                        <input type="number" id="card" name="card" placeholder="1,512,500" oninput="calculateTotal()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="totalSales">총매출:</label>
                    <input type="number" id="totalSales" name="totalSales" class="calculated" readonly>
                </div>

                <div class="row">
                    <div class="col">
                        <label for="service">서비스:</label>
                        <input type="number" id="service" name="service" placeholder="0" value="0">
                    </div>
                    <div class="col">
                        <label for="refund">반품액:</label>
                        <input type="number" id="refund" name="refund" placeholder="0" value="0" oninput="calculateSalesTotal()">
                    </div>
                </div>

                <div class="form-group">
                    <label for="salesTotal">매출합계:</label>
                    <input type="number" id="salesTotal" name="salesTotal" class="calculated" readonly>
                </div>

                <div class="form-group">
                    <label for="refundDetail">반품상세내역:</label>
                    <textarea id="refundDetail" name="refundDetail" placeholder="반품 상세 내역 입력" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label for="monthlyTotal">월누적매출:</label>
                    <input type="number" id="monthlyTotal" name="monthlyTotal" placeholder="31,748,000" oninput="calculatePredictedMonthly()">
                    <div id="monthlyPrediction" style="margin-top: 10px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; display: none;">
                        <div style="font-size: 14px; color: #856404; margin-bottom: 8px;">
                            <strong>예상 월누적매출:</strong> <span id="predictedMonthlyTotal">0</span>원
                        </div>
                        <div style="text-align: center;">
                            <button type="button" onclick="applyPredictedMonthly()" style="background-color: #28a745; font-size: 14px; padding: 8px 16px;">예상값 적용</button>
                            <button type="button" onclick="hidePrediction()" style="background-color: #6c757d; font-size: 14px; padding: 8px 16px;">무시</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>시재 정보</h3>
                <div class="row">
                    <div class="col">
                        <label for="todayCash">금일시제:</label>
                        <input type="number" id="todayCash" name="todayCash" placeholder="100,000" value="100000">
                    </div>
                    <div class="col">
                        <label for="tomorrowCash">익일시제:</label>
                        <input type="number" id="tomorrowCash" name="tomorrowCash" placeholder="100,000" value="100000">
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>지출 정보</h3>
                <div class="row">
                    <div class="col">
                        <label for="expenseCard">카드 지출:</label>
                        <input type="number" id="expenseCard" name="expenseCard" placeholder="0" value="0" oninput="calculateExpenseTotal()">
                    </div>
                    <div class="col">
                        <label for="expenseCash">현금 지출:</label>
                        <input type="number" id="expenseCash" name="expenseCash" placeholder="0" value="0" oninput="calculateExpenseTotal()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="expenseTotal">지출 총액:</label>
                    <input type="number" id="expenseTotal" name="expenseTotal" class="calculated" readonly>
                </div>

                <div class="row">
                    <div class="col">
                        <label for="shortageAmount">과부족 금액:</label>
                        <input type="number" id="shortageAmount" name="shortageAmount" placeholder="-13000" oninput="handleShortageAmountChange()">
                    </div>
                    <div class="col">
                        <label for="transferCount">계좌이체 건수:</label>
                        <input type="number" id="transferCount" name="transferCount" placeholder="1" oninput="handleTransferCountChange()">
                    </div>
                </div>

                <div class="form-group">
                    <label for="shortage">과부족:</label>
                    <input type="text" id="shortage" name="shortage" class="calculated" readonly>
                </div>
            </div>

            <div class="section">
                <h3>기타 정보</h3>
                <div class="row">
                    <div class="col">
                        <label for="review">리뷰:</label>
                        <input type="number" id="review" name="review" placeholder="3">
                    </div>
                    <div class="col">
                        <label for="revisit">재방문:</label>
                        <input type="number" id="revisit" name="revisit" placeholder="6">
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <label for="experienceAmount">체험단 서비스 금액:</label>
                        <input type="number" id="experienceAmount" name="experienceAmount" placeholder="0" oninput="handleExperienceAmountChange()">
                    </div>
                    <div class="col">
                        <label for="experienceCount">체험단 서비스 건수:</label>
                        <input type="number" id="experienceCount" name="experienceCount" placeholder="0" oninput="handleExperienceCountChange()">
                    </div>
                </div>

                <div class="form-group">
                    <label for="experienceService">체험단 서비스내역:</label>
                    <input type="text" id="experienceService" name="experienceService" class="calculated" readonly>
                </div>

                <div class="row">
                    <div class="col">
                        <label for="deliveryAmount">배민포장 금액:</label>
                        <input type="number" id="deliveryAmount" name="deliveryAmount" placeholder="0" oninput="handleDeliveryAmountChange()">
                    </div>
                    <div class="col">
                        <label for="deliveryCount">배민포장 횟수:</label>
                        <input type="number" id="deliveryCount" name="deliveryCount" placeholder="0" oninput="handleDeliveryCountChange()">
                    </div>
                </div>

                <div class="form-group">
                    <label for="delivery">배민포장:</label>
                    <input type="text" id="delivery" name="delivery" class="calculated" readonly>
                </div>
            </div>

            <div class="section">
                <h3>현금 계산</h3>
                <div class="form-group">
                    <label for="currentCash">현재시재:</label>
                    <input type="number" id="currentCash" name="currentCash" placeholder="0" oninput="calculateCashNeeded()">
                </div>

                <div class="form-group">
                    <label for="targetCash">목표시재:</label>
                    <input type="number" id="targetCash" name="targetCash" placeholder="100,000" value="100000" oninput="calculateCashNeeded()">
                </div>

                <div class="form-group">
                    <label for="cashEnvelope">현금총액 (돈봉투):</label>
                    <input type="number" id="cashEnvelope" name="cashEnvelope" placeholder="0" oninput="calculateCashNeeded()">
                </div>

                <div class="form-group">
                    <label for="cashDeposit">필요 현금입금액:</label>
                    <input type="number" id="cashDeposit" name="cashDeposit" class="calculated" readonly>
                </div>

                <div class="form-group">
                    <label for="cashAdjustment">돈봉투 증감량:</label>
                    <input type="number" id="cashAdjustment" name="cashAdjustment" class="calculated" readonly>
                </div>

                <div class="form-group">
                    <label for="finalCashEnvelope">최종 돈봉투 금액:</label>
                    <input type="number" id="finalCashEnvelope" name="finalCashEnvelope" class="calculated" readonly>
                </div>

                <div class="form-group">
                    <label for="cashCalculation">현금 계산:</label>
                    <input type="text" id="cashCalculation" name="cashCalculation" class="calculated" readonly>
                </div>
            </div>

            <div class="section">
                <h3>통장 관리</h3>
                <div class="form-group">
                    <label for="bankAccount">통장 잔액:</label>
                    <input type="number" id="bankAccount" name="bankAccount" placeholder="0" class="calculated">
                </div>
                
                <div class="row">
                    <div class="col">
                        <label for="bankAdjustment">증감 금액:</label>
                        <input type="number" id="bankAdjustment" name="bankAdjustment" placeholder="0">
                    </div>
                    <div class="col">
                        <div style="display: flex; gap: 10px; margin-top: 30px;">
                            <button type="button" onclick="adjustBankAccount('+')">+ 입금</button>
                            <button type="button" onclick="adjustBankAccount('-')">- 출금</button>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center;">
                <button type="button" onclick="generateReport()">보고서 생성</button>
                <button type="reset" class="reset-btn" onclick="resetForm()">초기화</button>
            </div>
        </form>

        <div id="result" class="result">
            <h3>생성된 보고서</h3>
            <pre id="reportContent"></pre>
            <div style="text-align: center;">
                <button type="button" id="copyBtn" class="copy-btn" onclick="copyReport()">보고서 복사</button>
            </div>
        </div>
    </div>

    <script>
        // 오늘 날짜를 기본값으로 설정
        document.addEventListener('DOMContentLoaded', function() {
            // 이전 입력값 불러오기 (날짜 설정 전에)
            loadSavedData();
            
            // 자동 저장 설정
            setupAutoSave();
            
            // 초기 계산들
            calculateShortage();
            calculateExperience();
            calculateDelivery();
            calculateCashNeeded();
            calculatePredictedMonthly();
        });
        
        // 보고서 섹션 초기 높이 설정
        window.addEventListener('load', function() {
            const reportSection = document.getElementById('reportSection');
            const urlParams = new URLSearchParams(window.location.search);
            
            // 압축된 데이터가 있거나 기존 URL 파라미터가 있으면 보고서 섹션을 접힌 상태로 시작
            const hasData = urlParams.get('d') || (urlParams.toString() && !urlParams.has('d'));
            
            if (hasData) {
                // 데이터가 있으면 접힌 상태로 설정
                collapseSection('reportSection');
            } else {
                // 데이터가 없으면 펼친 상태로 설정
                reportSection.style.maxHeight = reportSection.scrollHeight + 'px';
            }
        });

        // 필드명 매핑 (긴 필드명 → 짧은 코드)
        const fieldMapping = {
            // 매출 정보
            'monthlyTotal': 'mt',
            
            // 시재 정보
            'todayCash': 'tc',
            'tomorrowCash': 'tm',
            
            // 현금 계산
            'currentCash': 'cc',
            'targetCash': 'tg',
            'cashEnvelope': 'ce',
            
            // 통장
            'bankAccount': 'ba',
            'bankAdjustment': 'bad'
        };

        // 역매핑 (짧은 코드 → 긴 필드명)
        const reverseFieldMapping = Object.fromEntries(
            Object.entries(fieldMapping).map(([key, value]) => [value, key])
        );

        // 데이터 압축 함수
        function compressData(data) {
            // 저장에서 제외할 필드들
            const excludeFields = [
                'service', 'refund', 'refundDetail', 'review', 'revisit',
                'experienceAmount', 'experienceCount', 'deliveryAmount', 'deliveryCount',
                'date', 'shortageAmount', 'transferCount', 'cash', 'card', 
                'expenseCard', 'expenseCash'
            ];
            
            // 기본값이 있는 필드들 (이 필드들은 기본값과 다를 때만 저장)
            const defaultValues = {
                'todayCash': '100000',
                'tomorrowCash': '100000',
                'targetCash': '100000'
            };
            
            // 1. 필드명을 짧은 코드로 변환
            const compressed = {};
            Object.keys(data).forEach(key => {
                // 제외할 필드가 아니고, 매핑에 있는 필드인 경우
                if (!excludeFields.includes(key) && fieldMapping[key] && data[key] && data[key] !== '') {
                    // 기본값이 있는 필드는 기본값과 다를 때만 저장
                    if (defaultValues[key]) {
                        if (data[key] !== defaultValues[key]) {
                            compressed[fieldMapping[key]] = data[key];
                        }
                    } else {
                        // 기본값이 없는 필드는 빈 값이 아닌 경우 저장 (0도 포함)
                        compressed[fieldMapping[key]] = data[key];
                    }
                }
            });
            
            // 2. JSON으로 변환 후 Base64 인코딩
            const jsonString = JSON.stringify(compressed);
            const base64String = btoa(unescape(encodeURIComponent(jsonString)));
            
            return base64String;
        }

        // 데이터 압축 해제 함수
        function decompressData(compressedData) {
            try {
                // 1. Base64 디코딩
                const jsonString = decodeURIComponent(escape(atob(compressedData)));
                const compressed = JSON.parse(jsonString);
                
                // 2. 필드명을 원래대로 복원
                const decompressed = {};
                Object.keys(compressed).forEach(key => {
                    if (reverseFieldMapping[key]) {
                        const originalKey = reverseFieldMapping[key];
                        decompressed[originalKey] = compressed[key];
                    }
                });
                
                return decompressed;
            } catch (error) {
                console.error('데이터 압축 해제 실패:', error);
                return {};
            }
        }

        // URL에 데이터 저장 함수 (압축 적용)
        function saveData() {
            const formData = new FormData(document.getElementById('salesForm'));
            const data = Object.fromEntries(formData);
            
            // 날짜는 저장에서 제외
            delete data.date;
            
            // 데이터 압축
            const compressedData = compressData(data);
            
            if (compressedData && compressedData.length > 0) {
                // URL 파라미터로 압축된 데이터 사용
                const newUrl = window.location.pathname + '?d=' + encodeURIComponent(compressedData);
                
                // URL 업데이트 (페이지 새로고침 없이)
                window.history.replaceState({}, '', newUrl);
                console.log('URL에 데이터 저장됨:', newUrl.substring(0, 100) + '...');
            }
        }

        // URL에서 데이터 불러오기 함수 (압축 해제 적용)
        function loadSavedData() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // 압축된 데이터가 있는지 확인
            const compressedData = urlParams.get('d');
            
            if (compressedData) {
                try {
                    // 압축 해제
                    const data = decompressData(compressedData);
                    
                    // 데이터 로드
                    Object.keys(data).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && key !== 'date') {
                            element.value = data[key];
                        }
                    });
                    
                    // 계산 함수들 실행
                    calculateTotal();
                    calculateExpenseTotal();
                    calculateShortage();
                    calculateExperience();
                    calculateDelivery();
                    calculateCashNeeded();
                    calculatePredictedMonthly();
                } catch (error) {
                    console.error('압축 해제 중 오류:', error);
                }
            } else {
                // 기존 비압축 URL 파라미터 지원 (하위 호환성)
                const hasOldParams = urlParams.toString() && !urlParams.has('d');
                if (hasOldParams) {
                    urlParams.forEach((value, key) => {
                        const element = document.getElementById(key);
                        if (element && key !== 'date') {
                            element.value = value;
                        }
                    });
                    
                    // 계산 함수들 실행
                    calculateTotal();
                    calculateExpenseTotal();
                    calculateShortage();
                    calculateExperience();
                    calculateDelivery();
                    calculateCashNeeded();
                    calculatePredictedMonthly();
                    
                    // 기존 URL을 압축된 형태로 변환
                    saveData();
                } else {
                    // localStorage에서 마이그레이션 (기존 데이터)
                    const savedData = localStorage.getItem('salesFormData');
                    if (savedData) {
                        try {
                            const data = JSON.parse(savedData);
                            
                            Object.keys(data).forEach(key => {
                                if (key !== 'date') {
                                    const element = document.getElementById(key);
                                    if (element && data[key] !== '') {
                                        element.value = data[key];
                                    }
                                }
                            });
                            
                            // 계산 함수들 실행
                            calculateTotal();
                            calculateExpenseTotal();
                            calculateShortage();
                            calculateExperience();
                            calculateDelivery();
                            calculateCashNeeded();
                            calculatePredictedMonthly();
                            
                            // localStorage 데이터를 압축된 URL로 이전 후 삭제
                            saveData();
                            localStorage.removeItem('salesFormData');
                        } catch (error) {
                            console.error('저장된 데이터를 불러오는 중 오류가 발생했습니다:', error);
                        }
                    }
                }
            }
            
            // 날짜 필드가 비어있을 때만 오늘 날짜로 설정
            const dateInput = document.getElementById('date');
            if (!dateInput.value) {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
            }
        }

        // 입력값이 변경될 때마다 자동 저장
        function setupAutoSave() {
            const form = document.getElementById('salesForm');
            const inputs = form.querySelectorAll('input, textarea');
            
            // 저장에서 제외할 필드들
            const excludeFields = [
                'service', 'refund', 'refundDetail', 'review', 'revisit',
                'experienceAmount', 'experienceCount', 'deliveryAmount', 'deliveryCount',
                'date', 'shortageAmount', 'transferCount', 'cash', 'card', 
                'expenseCard', 'expenseCash', 'reportInput'
            ];
            
            inputs.forEach(input => {
                // 제외할 필드가 아니고 계산된 필드도 아닌 경우에만 자동 저장 이벤트 등록
                if (!excludeFields.includes(input.name) && 
                    !input.name.includes('date') && 
                    !input.classList.contains('calculated')) {
                    
                    // 기존 이벤트 리스너 제거 후 새로 추가
                    input.removeEventListener('input', saveData);
                    input.removeEventListener('change', saveData);
                    
                    input.addEventListener('input', function() {
                        // 약간의 지연을 두어 연속 입력 시 성능 향상
                        clearTimeout(this.saveTimeout);
                        this.saveTimeout = setTimeout(saveData, 300);
                    });
                    
                    input.addEventListener('change', saveData);
                }
            });
            
            console.log('자동 저장 설정 완료');
        }

        // 접기/펼치기 함수
        function toggleCollapse(elementId) {
            const content = document.getElementById(elementId);
            const header = content.previousElementSibling;
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                header.classList.remove('collapsed');
                content.style.maxHeight = content.scrollHeight + 'px';
            } else {
                content.classList.add('collapsed');
                header.classList.add('collapsed');
                content.style.maxHeight = '0px';
            }
        }

        // 섹션 접기 함수
        function collapseSection(elementId) {
            const content = document.getElementById(elementId);
            const header = content.previousElementSibling;
            
            content.classList.add('collapsed');
            header.classList.add('collapsed');
            content.style.maxHeight = '0px';
        }

        function calculateTotal() {
            const cash = parseFloat(document.getElementById('cash').value) || 0;
            const card = parseFloat(document.getElementById('card').value) || 0;
            const total = cash + card;
            document.getElementById('totalSales').value = total;
            calculateSalesTotal();
        }

        function calculateSalesTotal() {
            const totalSales = parseFloat(document.getElementById('totalSales').value) || 0;
            const refund = parseFloat(document.getElementById('refund').value) || 0;
            const salesTotal = totalSales - refund;
            document.getElementById('salesTotal').value = salesTotal;
            
            // 월누적매출 예상값 계산
            calculatePredictedMonthly();
        }

        function calculateExpenseTotal() {
            const expenseCard = parseFloat(document.getElementById('expenseCard').value) || 0;
            const expenseCash = parseFloat(document.getElementById('expenseCash').value) || 0;
            const expenseTotal = expenseCard + expenseCash;
            document.getElementById('expenseTotal').value = expenseTotal;
        }

        function calculateShortage() {
            const shortageAmount = parseFloat(document.getElementById('shortageAmount').value) || 0;
            const transferCount = parseInt(document.getElementById('transferCount').value) || 0;
            
            let shortageText = '';
            if (shortageAmount !== 0) {
                shortageText = `${shortageAmount.toLocaleString()}원`;
                if (transferCount > 0) {
                    shortageText += `(계좌이체 ${transferCount}건)`;
                }
            } else {
                shortageText = '0원';
            }
            
            document.getElementById('shortage').value = shortageText;
        }

        function handleShortageAmountChange() {
            const amount = parseFloat(document.getElementById('shortageAmount').value) || 0;
            const count = parseInt(document.getElementById('transferCount').value) || 0;
            
            // 금액이 0이 아니고 건수가 0일 때 자동으로 건수를 1로 설정
            if (amount !== 0 && count === 0) {
                document.getElementById('transferCount').value = 1;
            }
            // 금액이 0일 때 건수도 0으로 설정
            else if (amount === 0 && count !== 0) {
                document.getElementById('transferCount').value = 0;
            }
            
            calculateShortage();
        }

        function handleTransferCountChange() {
            const amount = parseFloat(document.getElementById('shortageAmount').value) || 0;
            const count = parseInt(document.getElementById('transferCount').value) || 0;
            
            // 건수가 0일 때 금액도 0으로 설정
            if (count === 0 && amount !== 0) {
                document.getElementById('shortageAmount').value = 0;
            }
            // 건수가 0이 아니고 금액이 0일 때 금액을 기본값으로 설정 (예: -13000)
            else if (count > 0 && amount === 0) {
                document.getElementById('shortageAmount').value = -13000;
            }
            
            calculateShortage();
        }

        function calculateExperience() {
            const experienceAmount = parseFloat(document.getElementById('experienceAmount').value) || 0;
            const experienceCount = parseInt(document.getElementById('experienceCount').value) || 0;
            
            const experienceText = `${experienceAmount.toLocaleString()}원(${experienceCount}건)`;
            document.getElementById('experienceService').value = experienceText;
        }

        function handleExperienceAmountChange() {
            const amount = parseFloat(document.getElementById('experienceAmount').value) || 0;
            const count = parseInt(document.getElementById('experienceCount').value) || 0;
            
            // 금액이 0보다 크고 건수가 0일 때 자동으로 건수를 1로 설정
            if (amount > 0 && count === 0) {
                document.getElementById('experienceCount').value = 1;
            }
            // 금액이 0일 때 건수도 0으로 설정
            else if (amount === 0 && count !== 0) {
                document.getElementById('experienceCount').value = 0;
            }
            
            calculateExperience();
        }

        function handleExperienceCountChange() {
            const amount = parseFloat(document.getElementById('experienceAmount').value) || 0;
            const count = parseInt(document.getElementById('experienceCount').value) || 0;
            
            // 건수가 0일 때 금액도 0으로 설정
            if (count === 0 && amount !== 0) {
                document.getElementById('experienceAmount').value = 0;
            }
            
            calculateExperience();
        }

        function calculateDelivery() {
            const deliveryCount = parseInt(document.getElementById('deliveryCount').value) || 0;
            const deliveryAmount = parseFloat(document.getElementById('deliveryAmount').value) || 0;
            
            const deliveryText = `${deliveryCount}회(${deliveryAmount.toLocaleString()}원)`;
            document.getElementById('delivery').value = deliveryText;
        }

        function handleDeliveryAmountChange() {
            const amount = parseFloat(document.getElementById('deliveryAmount').value) || 0;
            const count = parseInt(document.getElementById('deliveryCount').value) || 0;
            
            // 금액이 0보다 크고 건수가 0일 때 자동으로 건수를 1로 설정
            if (amount > 0 && count === 0) {
                document.getElementById('deliveryCount').value = 1;
            }
            // 금액이 0일 때 건수도 0으로 설정
            else if (amount === 0 && count !== 0) {
                document.getElementById('deliveryCount').value = 0;
            }
            
            calculateDelivery();
        }

        function handleDeliveryCountChange() {
            const amount = parseFloat(document.getElementById('deliveryAmount').value) || 0;
            const count = parseInt(document.getElementById('deliveryCount').value) || 0;
            
            // 건수가 0일 때 금액도 0으로 설정
            if (count === 0 && amount !== 0) {
                document.getElementById('deliveryAmount').value = 0;
            }
            
            calculateDelivery();
        }

        function calculateCashNeeded() {
            const currentCash = parseFloat(document.getElementById('currentCash').value) || 0;
            const targetCash = parseFloat(document.getElementById('targetCash').value) || 100000;
            const cashEnvelope = parseFloat(document.getElementById('cashEnvelope').value) || 0;
            
            // 목표시재를 맞추기 위해 필요한 현금입금액
            const neededCash = targetCash - currentCash;
            
            // 돈봉투 증감량 = 필요한 현금입금액 (사용할 금액이므로 음수로 표시)
            const cashAdjustment = -neededCash;
            
            // 최종 돈봉투 금액 = 현재 돈봉투 - 사용할 금액
            const finalCashEnvelope = cashEnvelope - neededCash;
            
            document.getElementById('cashDeposit').value = neededCash;
            document.getElementById('cashAdjustment').value = cashAdjustment;
            document.getElementById('finalCashEnvelope').value = finalCashEnvelope;
            
            // 계산식 표시 (돈봉투에서 필요한 금액을 빼는 형태)
            if (neededCash >= 0) {
                document.getElementById('cashCalculation').value = `돈봉투 ${cashEnvelope.toLocaleString()}원 - ${neededCash.toLocaleString()}원 = ${finalCashEnvelope.toLocaleString()}원`;
            } else {
                // 현재시재가 목표시재보다 많을 경우 (돈봉투에 추가)
                document.getElementById('cashCalculation').value = `돈봉투 ${cashEnvelope.toLocaleString()}원 + ${Math.abs(neededCash).toLocaleString()}원 = ${finalCashEnvelope.toLocaleString()}원`;
            }
        }

        function calculatePredictedMonthly() {
            const currentMonthly = parseFloat(document.getElementById('monthlyTotal').value) || 0;
            const todaySales = parseFloat(document.getElementById('salesTotal').value) || 0;
            
            // 오늘 매출이 있고, 현재 월누적매출이 있을 때만 예상값 표시
            if (todaySales > 0 && currentMonthly >= 0) {
                const predictedMonthly = currentMonthly + todaySales;
                document.getElementById('predictedMonthlyTotal').textContent = predictedMonthly.toLocaleString();
                document.getElementById('monthlyPrediction').style.display = 'block';
            } else {
                document.getElementById('monthlyPrediction').style.display = 'none';
            }
        }

        function applyPredictedMonthly() {
            const predictedValue = document.getElementById('predictedMonthlyTotal').textContent.replace(/,/g, '');
            document.getElementById('monthlyTotal').value = predictedValue;
            document.getElementById('monthlyPrediction').style.display = 'none';
            
            // 데이터 저장
            saveData();
        }

        function hidePrediction() {
            document.getElementById('monthlyPrediction').style.display = 'none';
        }

        function adjustBankAccount(operation) {
            const currentBank = parseFloat(document.getElementById('bankAccount').value) || 0;
            const adjustment = parseFloat(document.getElementById('bankAdjustment').value) || 0;
            
            if (adjustment === 0) {
                alert('증감 금액을 입력해주세요.');
                return;
            }
            
            let newBalance;
            if (operation === '+') {
                newBalance = currentBank + adjustment;
            } else {
                newBalance = currentBank - adjustment;
            }
            
            document.getElementById('bankAccount').value = newBalance;
            document.getElementById('bankAdjustment').value = 0;
        }

        function loadFromReport() {
            const reportText = document.getElementById('reportInput').value;
            if (!reportText.trim()) {
                alert('보고서 텍스트를 입력해주세요.');
                return;
            }
            
            try {
                // 날짜 추출
                // const dateMatch = reportText.match(/(\d{4})년\s*(\d{1,2})월\s*(\d{1,2})일/);
                // if (dateMatch) {
                //     const year = dateMatch[1];
                //     const month = dateMatch[2].padStart(2, '0');
                //     const day = dateMatch[3].padStart(2, '0');
                //     document.getElementById('date').value = `${year}-${month}-${day}`;
                // }
                
                // 매출 정보 추출
                const cashMatch = reportText.match(/현금:\s*([\d,]+)원/);
                if (cashMatch) document.getElementById('cash').value = cashMatch[1].replace(/,/g, '');
                
                const cardMatch = reportText.match(/카드:\s*([\d,]+)원/);
                if (cardMatch) document.getElementById('card').value = cardMatch[1].replace(/,/g, '');
                
                const serviceMatch = reportText.match(/서비스:\s*([\d,]+)원/);
                if (serviceMatch) document.getElementById('service').value = serviceMatch[1].replace(/,/g, '');
                
                const refundMatch = reportText.match(/반품액:\s*([\d,]+)원/);
                if (refundMatch) document.getElementById('refund').value = refundMatch[1].replace(/,/g, '');
                
                const refundDetailMatch = reportText.match(/반품상세내역:\s*(.+)/);
                if (refundDetailMatch) document.getElementById('refundDetail').value = refundDetailMatch[1];
                
                const monthlyMatch = reportText.match(/월누적매출:\s*([\d,]+)원/);
                if (monthlyMatch) document.getElementById('monthlyTotal').value = monthlyMatch[1].replace(/,/g, '');
                
                // 시재 정보
                const todayCashMatch = reportText.match(/금일시제:\s*([\d,]+)원/);
                if (todayCashMatch) document.getElementById('todayCash').value = todayCashMatch[1].replace(/,/g, '');
                
                const tomorrowCashMatch = reportText.match(/익일시제:\s*([\d,]+)원/);
                if (tomorrowCashMatch) document.getElementById('tomorrowCash').value = tomorrowCashMatch[1].replace(/,/g, '');
                
                // 지출 정보
                const expenseCardMatch = reportText.match(/카드\s*:\s*([\d,]+)원/);
                if (expenseCardMatch) document.getElementById('expenseCard').value = expenseCardMatch[1].replace(/,/g, '');
                
                const expenseCashMatch = reportText.match(/현금\s*:\s*([\d,]+)원/);
                if (expenseCashMatch) document.getElementById('expenseCash').value = expenseCashMatch[1].replace(/,/g, '');
                
                // 과부족
                const shortageMatch = reportText.match(/과부족:\s*(-?[\d,]+)원(?:\(계좌이체\s*(\d+)건\))?/);
                if (shortageMatch) {
                    document.getElementById('shortageAmount').value = shortageMatch[1].replace(/,/g, '');
                    if (shortageMatch[2]) {
                        document.getElementById('transferCount').value = shortageMatch[2];
                    }
                }
                
                // 기타 정보
                const reviewMatch = reportText.match(/리뷰:\s*(\d+)팀/);
                if (reviewMatch) document.getElementById('review').value = reviewMatch[1];
                
                const revisitMatch = reportText.match(/재방문:\s*(\d+)팀/);
                if (revisitMatch) document.getElementById('revisit').value = revisitMatch[1];
                
                // 체험단 서비스
                const experienceMatch = reportText.match(/체험단 서비스내역:\s*([\d,]+)원\((\d+)건\)/);
                if (experienceMatch) {
                    document.getElementById('experienceAmount').value = experienceMatch[1].replace(/,/g, '');
                    document.getElementById('experienceCount').value = experienceMatch[2];
                }
                
                // 배민포장
                const deliveryMatch = reportText.match(/배민포장:\s*(\d+)회\(([\d,]+)원\)/);
                if (deliveryMatch) {
                    document.getElementById('deliveryCount').value = deliveryMatch[1];
                    document.getElementById('deliveryAmount').value = deliveryMatch[2].replace(/,/g, '');
                }
                
                // 현금총액과 통장
                const cashEnvelopeMatch = reportText.match(/현금총액\(돈봉투\):\s*([\d,]+)원/);
                if (cashEnvelopeMatch) document.getElementById('cashEnvelope').value = cashEnvelopeMatch[1].replace(/,/g, '');
                
                const bankMatch = reportText.match(/통장:\s*([\d,]+)원/);
                if (bankMatch) document.getElementById('bankAccount').value = bankMatch[1].replace(/,/g, '');
                
                // 계산 함수들 호출
                calculateTotal();
                calculateExpenseTotal();
                calculateShortage();
                calculateExperience();
                calculateDelivery();
                calculateCashNeeded();
                calculatePredictedMonthly();
                
                // 데이터를 URL에 저장
                saveData();
                
                // 성공적으로 불러온 후 보고서 섹션 접기
                collapseSection('reportSection');
                
                // alert('보고서에서 데이터를 성공적으로 불러왔습니다!');
                document.getElementById('reportInput').value = '';
                
            } catch (error) {
                alert('보고서 형식을 인식할 수 없습니다. 올바른 보고서를 입력해주세요.');
                console.error('Error parsing report:', error);
            }
        }

        function generateReport() {
            const formData = new FormData(document.getElementById('salesForm'));
            const data = Object.fromEntries(formData);
            
            // 기본값 설정
            const defaults = {
                cash: 0,
                card: 0,
                service: 0,
                refund: 0,
                refundDetail: '0원',
                monthlyTotal: 0,
                todayCash: 100000,
                tomorrowCash: 100000,
                expenseCard: 0,
                expenseCash: 0,
                shortage: '0원',
                review: 0,
                revisit: 0,
                experienceService: '0원(0건)',
                delivery: '0회(0원)',
                cashDeposit: 0
            };

            // 날짜 포맷팅
            const dateStr = data.date || new Date().toISOString().split('T')[0];
            const [year, month, day] = dateStr.split('-');
            const formattedDate = `${year}년 ${month}월 ${day}일 (${getDayOfWeek(dateStr)})`;

            // 값이 비어있으면 기본값 사용
            const cash = parseInt(data.cash) || defaults.cash;
            const card = parseInt(data.card) || defaults.card;
            const totalSales = cash + card;
            const refund = parseInt(data.refund) || defaults.refund;
            const salesTotal = totalSales - refund;
            const expenseCard = parseInt(data.expenseCard) || defaults.expenseCard;
            const expenseCash = parseInt(data.expenseCash) || defaults.expenseCash;
            const expenseTotal = expenseCard + expenseCash;
            
            const report = `${formattedDate} 미례국밥 전포점
총매출: ${totalSales.toLocaleString()}원
 현금:  ${cash.toLocaleString()}원
 카드:  ${card.toLocaleString()}원
서비스: ${(parseInt(data.service) || defaults.service).toLocaleString()}원
 반품액: ${refund.toLocaleString()}원
 매출합계: ${salesTotal.toLocaleString()}원
반품상세내역: ${data.refundDetail || defaults.refundDetail}
월누적매출: ${(parseInt(data.monthlyTotal) || defaults.monthlyTotal).toLocaleString()}원
금일시제: ${(parseInt(data.todayCash) || defaults.todayCash).toLocaleString()}원
익일시제: ${(parseInt(data.tomorrowCash) || defaults.tomorrowCash).toLocaleString()}원
지출상세내역
  카드 : ${expenseCard.toLocaleString()}원
  현금 : ${expenseCash.toLocaleString()}원
  total: ${expenseTotal.toLocaleString()}원
과부족:  ${data.shortage || defaults.shortage}
리뷰: ${data.review || defaults.review}팀
체험단 서비스내역: ${data.experienceService || defaults.experienceService}
재방문: ${data.revisit || defaults.revisit}팀
배민포장: ${data.delivery || defaults.delivery}
현금총액(돈봉투): ${(parseInt(data.finalCashEnvelope) || parseInt(data.cashEnvelope) || 0).toLocaleString()}원
통장: ${(parseInt(data.bankAccount) || 0).toLocaleString()}원`;

            // 기존 보고서 내용 초기화
            document.getElementById('reportContent').textContent = report;
            document.getElementById('result').style.display = 'block';
        }

        function getDayOfWeek(dateStr) {
            const days = ['일', '월', '화', '수', '목', '금', '토'];
            const date = new Date(dateStr);
            return days[date.getDay()];
        }

        function copyReport() {
            const reportContent = document.getElementById('reportContent').textContent;
            navigator.clipboard.writeText(reportContent).then(function() {
                const button = document.getElementById('copyBtn');
                const originalText = button.textContent;
                button.textContent = '복사완료!';
                button.style.backgroundColor = '#28a745';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.backgroundColor = '#007bff';
                }, 2000);
            }).catch(function(err) {
                alert('복사에 실패했습니다: ' + err);
            });
        }

        function resetForm() {
            document.getElementById('salesForm').reset();
            
            // 날짜를 오늘로 설정 (정확한 형식으로)
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${year}-${month}-${day}`;
            
            document.getElementById('result').style.display = 'none';
            // 기본값들 다시 설정
            document.getElementById('service').value = '0';
            document.getElementById('refund').value = '0';
            document.getElementById('todayCash').value = '100000';
            document.getElementById('tomorrowCash').value = '100000';
            document.getElementById('expenseCard').value = '0';
            document.getElementById('expenseCash').value = '0';
            document.getElementById('shortageAmount').value = '0';
            document.getElementById('transferCount').value = '0';
            document.getElementById('experienceAmount').value = '0';
            document.getElementById('experienceCount').value = '0';
            document.getElementById('deliveryCount').value = '0';
            document.getElementById('deliveryAmount').value = '0';
            document.getElementById('targetCash').value = '100000';
            document.getElementById('currentCash').value = '0';
            document.getElementById('cashEnvelope').value = '0';
            document.getElementById('bankAccount').value = '0';
            document.getElementById('bankAdjustment').value = '0';
            document.getElementById('reportInput').value = '';
            // 계산 함수들 호출
            calculateShortage();
            calculateExperience();
            calculateDelivery();
            calculateCashNeeded();
            calculatePredictedMonthly();
        }

        // 수동 저장 함수 (URL 복사) - 압축률 표시 추가
        function saveDataManually() {
            const originalUrl = window.location.href;
            const originalLength = originalUrl.length;
            
            saveData();
            
            const compressedUrl = window.location.href;
            const compressedLength = compressedUrl.length;
            const compressionRatio = originalLength > 0 ? ((originalLength - compressedLength) / originalLength * 100).toFixed(1) : 0;
            
            // URL 복사 기능 추가
            navigator.clipboard.writeText(window.location.href).then(function() {
                alert(`데이터가 압축되어 URL에 저장되었습니다!\nURL 길이: ${compressedLength}자\n압축률: ${compressionRatio > 0 ? compressionRatio + '% 단축' : '최적화됨'}\n클립보드에 복사되었습니다!`);
            }).catch(function(err) {
                alert(`데이터가 압축되어 URL에 저장되었습니다!\nURL 길이: ${compressedLength}자\n압축률: ${compressionRatio > 0 ? compressionRatio + '% 단축' : '최적화됨'}\n\n${window.location.href}`);
            });
        }

        // 저장된 데이터 삭제 (URL 파라미터 제거)
        function clearSavedData() {
            if (confirm('URL에 저장된 모든 데이터를 삭제하시겠습니까?')) {
                // URL 파라미터 제거
                window.history.replaceState({}, '', window.location.pathname);
                
                // 폼 초기화
                resetForm();
                
                alert('URL에 저장된 데이터가 삭제되었습니다!');
            }
        }
    </script>
</body>
</html>